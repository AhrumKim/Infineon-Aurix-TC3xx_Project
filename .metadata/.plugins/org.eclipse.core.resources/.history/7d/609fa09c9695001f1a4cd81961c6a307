/*
 * PWM.c
 *
 *  Created on: 2024. 10. 29.
 *      Author: FM23
 */

#include "PWM.h"

void init_Tom(void)
{
    IfxGtm_Tom_Timer_Config timerConfig;
    IfxGtm_Tom_Timer_initConfig(&timerConfig, &MODULE_GTM);

    timerConfig.base.frequency = 2000; /*PWM 주기*/
    timerConfig.base.isrPriority =  PRIORITY_GTM; /*인터럽트 우선순위*/
    timerConfig.base.isrProvider = IfxSrc_Tos_cpu0; /*인터럽트 처리 cpu  설정*/
    timerConfig.base.minResolution = (1.0/timerConfig.base.frequency)/1000; /*최소 분해능 설정*/
    timerConfig.clock             = IfxGtm_Tom_Ch_ClkSrc_cmuFxclk0; /*Base Clock (100MHz)에서 몇을 나누어 사용할지*/
    timerConfig.base.countDir     = IfxStdIf_Timer_CountDir_upAndDown; /*비교파 모양 설정*/


    timerConfig.tom               = IfxGtm_Tom_0; /*몇 번째 TOM 사용할지 설정*/
    timerConfig.timerChannel      = IfxGtm_Tom_Ch_0;   /* TOM 채널 설정 */
    timerConfig.triggerOut        =&IfxGtm_TOM0_0_TOUT77_P15_6_OUT;  /*trigger 출력 핀 설정 */


    timerConfig.base.trigger.enabled        = TRUE; /*trigger 활성화*/
    timerConfig.base.trigger.outputEnabled  = TRUE; /*trigger 출력 활성화 */
    timerConfig.base.trigger.triggerPoint   = 500; /*이벤트 발생(ex: 1) 후 몇 틱(tick) 후에 이벤트를 끝낼지(ex:0)*/
    timerConfig.base.trigger.risingEdgeAtPeriod  = TRUE; /*디폴트를 0으로 할지 1로 할지(ex: TRUE --> 디폴트 0, 이벤트 발생 시 1)*/

    IfxGtm_Tom_Timer_init(&GtmPwmHl.timer, &timerConfig); /*설정 값 반영*/

    init_PWM(&timerConfig); /*PWM 초기 설정*/

}

IFX_INTERRUPT(ISR_PWM_GTM, 0, PRIORITY_GTM);
void IST_PWM_GTM(void)
{
    IfxCpu_enacledInterrupts();
    IfxGtm_Tom_Timer_acknowledgeTimerIrq(&GtmPwmHl.timer);
}

void init_PWM(IfxGtm_Tom_Timer_Config*timerConfig)
{
    IfxGtm_Tom_PwmHl_Config pwmHlConfig;/*Hl(Hardware level)*/  /*pwm 구조체 선언*/
    IfxGtm_Tom_PwmHl_initConfig(&pwmHlConfig); /*구조체 디폴트 값으로 초기화*/

    IfxGtm_Tom_ToutMapP ccx[2], coutx[2];
    ccx[0] = &IfxGtm_TOM0_4_TOUT22_P33_0_OUT; /*40*/ /*PWM 출력 핀 설정 Ch.1 ccx*/
    coutx[0] = &IfxGtm_TOM0_3_TOUT105_P10_3_OUT; /*11*/ /*PWM 출력 핀 설정 Ch.1 coutx*/

    ccx[1] = &IfxGtm_TOM0_5_TOUT23_P33_1_OUT; /*38*/ /*PWM 출력 핀 설정 Ch.2 ccx*/
    coutx[0] = &IfxGtm_TOM0_2_TOUT107_P10_5_OUT; /*10*/ /*PWM 출력 핀 설정 Ch.2 coutx*/


    pwmHlConfig.timer    = &GtmPwmHl.timer;  /*타이머 객체 설정*/
    pwmHlConfig.tom      = timerConfig->tom; /*TOM 설정*/
    pwmHlConfig.base.deadtime = 2e-6;       /*데드타임 설정*/
    pwmHlConfig.base.minPulse = 1e-6; /*최소 펄스 시간 설정*/
    pwmHlConfig.base.channelCount  = 2;  /*pwm 채널 수 설정*/
    pwmHlConfig.base.emergencyEnabled = FALSE; /*비상 기능 설정*/



}
